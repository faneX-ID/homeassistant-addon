name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, master]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  validate:
    name: "üõ°Ô∏è Addon Validation"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          pip install pyyaml jsonschema

      - name: Validate Repository Structure
        run: |
          if [ ! -f "repository.json" ]; then
            echo "‚ùå repository.json not found"
            exit 1
          fi
          if [ ! -d "fanexid" ]; then
            echo "‚ùå fanexid directory not found"
            exit 1
          fi
          echo "‚úÖ Repository structure valid"

      - name: Validate YAML Files
        run: |
          python << 'EOF'
          import yaml
          import json
          import sys
          from pathlib import Path

          errors = []

          # Validate repository.json
          try:
              with open('repository.json') as f:
                  repo_data = json.load(f)
              required = ['name', 'url']
              for field in required:
                  if field not in repo_data:
                      errors.append(f"repository.json missing: {field}")
              print("‚úÖ repository.json valid")
          except Exception as e:
              errors.append(f"repository.json: {e}")

          # Validate addon config.yaml
          config_path = Path('fanexid/config.yaml')
          if config_path.exists():
              try:
                  with open(config_path) as f:
                      config = yaml.safe_load(f)
                  required = ['name', 'version', 'slug', 'description']
                  for field in required:
                      if field not in config:
                          errors.append(f"config.yaml missing: {field}")
                  print("‚úÖ config.yaml valid")
              except Exception as e:
                  errors.append(f"config.yaml: {e}")
          else:
              errors.append("config.yaml not found")

          # Validate build.yaml
          build_path = Path('fanexid/build.yaml')
          if build_path.exists():
              try:
                  with open(build_path) as f:
                      build = yaml.safe_load(f)
                  if 'build_from' not in build:
                      errors.append("build.yaml missing build_from")
                  print("‚úÖ build.yaml valid")
              except Exception as e:
                  errors.append(f"build.yaml: {e}")
          else:
              errors.append("build.yaml not found")

          if errors:
              print("\n‚ùå Validation errors:")
              for e in errors:
                  print(f"  - {e}")
              sys.exit(1)
          EOF

      - name: Validate Dockerfile
        run: |
          if [ ! -f "fanexid/Dockerfile" ]; then
            echo "‚ùå Dockerfile not found"
            exit 1
          fi
          if ! grep -q "FROM" fanexid/Dockerfile; then
            echo "‚ùå Dockerfile invalid"
            exit 1
          fi
          echo "‚úÖ Dockerfile valid"

      - name: Check Required Files
        run: |
          for file in fanexid/config.yaml fanexid/build.yaml fanexid/Dockerfile fanexid/run.sh; do
            if [ ! -f "$file" ]; then
              echo "‚ùå Missing: $file"
              exit 1
            fi
          done
          echo "‚úÖ All required files present"

  feedback:
    needs: [validate]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            const status = '${{ needs.validate.result }}';
            if (status === 'success') {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: "‚úÖ **PR Validation Passed!**\n\nAll checks passed successfully."
              });
            } else {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: "‚ùå **PR Validation Failed**\n\nPlease check the logs and fix the issues."
              });
            }
