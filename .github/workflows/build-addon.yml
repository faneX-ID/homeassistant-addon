name: Build Add-on

on:
  push:
    branches: [main, master]
    paths:
      - 'fanexid/**'
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'fanexid/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    name: Build Home Assistant Add-on
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Validate Add-on Structure
        run: |
          if [ ! -f "fanexid/config.yaml" ]; then
            echo "‚ùå fanexid/config.yaml not found"
            exit 1
          fi
          if [ ! -f "fanexid/build.yaml" ]; then
            echo "‚ùå fanexid/build.yaml not found"
            exit 1
          fi
          if [ ! -f "fanexid/Dockerfile" ]; then
            echo "‚ùå fanexid/Dockerfile not found"
            exit 1
          fi
          echo "‚úÖ Add-on structure valid"

      - name: Extract Add-on Version
        id: version
        run: |
          python << 'EOF'
          import yaml
          with open('fanexid/config.yaml') as f:
              config = yaml.safe_load(f)
          version = config.get('version', '0.0.0')
          slug = config.get('slug', 'fanexid')
          print(f"version={version}")
          print(f"slug={slug}")
          EOF

      - name: Build Add-on Image (Test)
        uses: docker/build-push-action@v6
        with:
          context: ./fanexid
          file: ./fanexid/Dockerfile
          platforms: linux/amd64
          push: false
          tags: |
            fanexid:test
          cache-from: type=gha,scope=addon-build
          cache-to: type=gha,mode=max,scope=addon-build

      - name: Build Summary
        if: always()
        run: |
          echo "## üèóÔ∏è Add-on Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Add-on Build | ${{ job.status == 'success' && '‚úÖ Success' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Add-on:** ${{ steps.version.outputs.slug }}" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY

